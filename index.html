<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiTaPa - راحة البال والعناية بك</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- إضافة Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // بيانات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyA6cIVcrYl2DyXuGPpdi8SFlR0VJH2XqMo",
            authDomain: "animated-joy-475105-c9.firebaseapp.com",
            projectId: "animated-joy-475105-c9",
            storageBucket: "animated-joy-475105-c9.firebasestorage.app",
            messagingSenderId: "481947148423",
            appId: "1:481947148423:web:4e0a8b1c77e2dfc76a1822",
            measurementId: "G-KJ8CEDEFJ2"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // جعلها متاحة عالمياً
        window.firebaseApp = {
            db,
            auth,
            collection,
            addDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            onAuthStateChanged,
            signInAnonymously
        };

        console.log("Firebase initialized successfully!");
    </script>

    <style>
        /* جميع أنماط CSS السابقة تبقى كما هي */
        :root {
            --primary: #FFB6C1;
            --primary-light: #FFE4E6;
            --primary-dark: #DB7093;
            --secondary: #D8BFD8;
            --accent: #FF69B4;
            --gold: #D4AF37;
            --light: #FFF9FB;
            --dark: #4A4A4A;
            --gray: #A5A5B5;
            --success: #8FBC8F;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 20px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* باقي الأنماط تبقى كما هي */
        /* ... */
    </style>
</head>
<body>
    <!-- الهيكل HTML تبقى كما هي -->
    <!-- ... -->

    <script>
        // دالة للاتصال بـ Firebase
        async function initializeFirebase() {
            try {
                const { auth, signInAnonymously, onAuthStateChanged } = window.firebaseApp;
                
                // تسجيل الدخول كمستخدم مجهول
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User signed in:", user.uid);
                        loadChatMessages();
                        setupChatListener();
                    } else {
                        console.log("User signed out");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }
        }

        // دالة لتحميل الرسائل السابقة
        async function loadChatMessages() {
            const { db, collection, query, orderBy, onSnapshot } = window.firebaseApp;
            
            const q = query(collection(db, "messages"), orderBy("timestamp", "asc"));
            
            onSnapshot(q, (snapshot) => {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    addMessageToUI(message.text, message.sender, message.timestamp);
                });
            });
        }

        // دالة لإرسال رسالة جديدة
        async function sendMessage(messageText, sender) {
            const { db, collection, addDoc, serverTimestamp } = window.firebaseApp;
            
            try {
                await addDoc(collection(db, "messages"), {
                    text: messageText,
                    sender: sender,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending message:", error);
            }
        }

        // دالة لإضافة رسالة إلى الواجهة
        function addMessageToUI(message, sender, timestamp) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            
            const className = sender === 'user' ? 'user-message' : 'bot-message';
            const displayName = sender === 'user' ? 'أنت' : 'تيتابا';
            
            const time = timestamp ? new Date(timestamp.toDate()).toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            }) : 'الآن';
            
            messageElement.className = `message ${className}`;
            messageElement.innerHTML = `
                ${displayName}: ${message}
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // معالجة إرسال النموذج
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            // إضافة رسالة المستخدم إلى Firebase
            await sendMessage(message, 'user');
            input.value = '';

            // محاكاة رد البوت
            setTimeout(async () => {
                const botResponse = generateResponse(message);
                await sendMessage(botResponse, 'bot');
            }, 1500);
        });

        // دالة توليد ردود البوت (نفس الدالة السابقة)
        function generateResponse(message) {
            const responses = {
                'مرحبا': ['مرحباً! كيف يمكنني مساعدتك؟', 'أهلاً وسهلاً! كيف حالك؟'],
                'كيف حالك': ['أنا بخير، شكراً لسؤالك!', 'الحمد لله، وأتمنى أن تكون أنت أيضاً بخير'],
                'شكرا': ['العفو!', 'لا شكر على واجب'],
                'default': ['أنا هنا لمساعدتك!', 'هل يمكنك توضيح سؤالك أكثر؟']
            };

            const lowerMessage = message.toLowerCase();
            
            for (const [key, value] of Object.entries(responses)) {
                if (lowerMessage.includes(key)) {
                    const randomIndex = Math.floor(Math.random() * value.length);
                    return value[randomIndex];
                }
            }
            
            return responses.default[Math.floor(Math.random() * responses.default.length)];
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
</body>
</html>
